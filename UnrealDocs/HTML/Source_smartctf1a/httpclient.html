<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<title>UT2004 UnrealScript - Source: SmartCTF1A.HTTPClient</title>
	<meta name="Generator" content="UnCodeX 241" />
	<link rel="stylesheet" href="../DocStyle2.css" type="text/css" title="Original Purple" />
	<link rel="alternative stylesheet" href="../DocStyle2-blue.css" type="text/css" title="Blue" />
	<link rel="alternative stylesheet" href="../DocStyle2-red.css" type="text/css" title="Red" />
	<!--[if IE]>
	<link rel="stylesheet" href="../DocStyle2-msie.css" type="text/css" />
	<![endif]-->
	<script src="../styleswitcher.js" type="text/javascript"></script>
</head>
<body>

<div class="header">
<table class="header">
<tr class="header">
	<td class="header"><a href="../overview.html">Overview</a></td>
	<td class="header"><a href="../smartctf1a/smartctf1a-overview.html">Package</a></td>
	<td class="header"><a href="../smartctf1a/httpclient.html">Class</a></td>
	<td class="header_hilight">Source</td>
	<td class="header"><a class="header" href="../classtree.html#HTTPClient">Class tree</a></td>
	<td class="header"><a class="header" href="../glossary_A.html">Glossary</a></td>
	<td class="logo" rowspan="2">UnrealScript<br />Documentation</td>
</tr>
<tr>
	<td class="subheader" colspan="3"><a href="../Source_smartctf1a/browserhttpclient.html">previous class</a> &nbsp;&nbsp;&nbsp;&nbsp; <a href="../Source_smartctf1a/linkactor.html">next class</a></td>
	<td class="subheader" colspan="2"><a href="../index.html#Source_smartctf1a/httpclient.html" target="_top">frames</a> &nbsp;&nbsp;&nbsp;&nbsp; <a href="" target="_top">no frames</a></td>
</tr>
</table>
</div>
<div class="spacer"></div>

<h1><a href="../smartctf1a/smartctf1a-overview.html">SmartCTF1A</a>.<a href="../smartctf1a/httpclient.html">HTTPClient</a></h1>
<br />
<div class="source"><table class="source"><tr><td class="source_lineno"><span class="source_lineno">00001<br />00002<br />00003<br />00004<br />00005<br />00006<br />00007<br />00008<br />00009<br />00010<br />00011<br />00012<br />00013<br />00014<br />00015<br />00016<br />00017<br />00018<br />00019<br />00020<br />
00021<br />00022<br />00023<br />00024<br />00025<br />00026<br />00027<br />00028<br />00029<br />00030<br />00031<br />00032<br />00033<br />00034<br />00035<br />00036<br />00037<br />00038<br />00039<br />00040<br />
00041<br />00042<br />00043<br />00044<br />00045<br />00046<br />00047<br />00048<br />00049<br />00050<br />00051<br />00052<br />00053<br />00054<br />00055<br />00056<br />00057<br />00058<br />00059<br />00060<br />
00061<br />00062<br />00063<br />00064<br />00065<br />00066<br />00067<br />00068<br />00069<br />00070<br />00071<br />00072<br />00073<br />00074<br />00075<br />00076<br />00077<br />00078<br />00079<br />00080<br />
00081<br />00082<br />00083<br />00084<br />00085<br />00086<br />00087<br />00088<br />00089<br />00090<br />00091<br />00092<br />00093<br />00094<br />00095<br />00096<br />00097<br />00098<br />00099<br />00100<br />
00101<br />00102<br />00103<br />00104<br />00105<br />00106<br />00107<br />00108<br />00109<br />00110<br />00111<br />00112<br />00113<br />00114<br />00115<br />00116<br />00117<br />00118<br />00119<br />00120<br />
00121<br />00122<br />00123<br />00124<br />00125<br />00126<br />00127<br />00128<br />00129<br />00130<br />00131<br />00132<br />00133<br />00134<br />00135<br />00136<br />00137<br />00138<br />00139<br />00140<br />
00141<br />00142<br />00143<br />00144<br />00145<br />00146<br />00147<br />00148<br />00149<br />00150<br />00151<br />00152<br />00153<br />00154<br />00155<br />00156<br />00157<br />00158<br />00159<br />00160<br />
00161<br />00162<br />00163<br />00164<br />00165<br />00166<br />00167<br />00168<br />00169<br />00170<br />00171<br />00172<br />00173<br />00174<br />00175<br />00176<br />00177<br />00178<br />00179<br />00180<br />
00181<br />00182<br />00183<br />00184<br />00185<br />00186<br />00187<br />00188<br />00189<br />00190<br />00191<br />00192<br />00193<br />00194<br />00195<br />00196<br />00197<br />00198<br />00199<br />00200<br />
00201<br />00202<br />00203<br />00204<br />00205<br />00206<br />00207<br />00208<br />00209<br />00210<br />00211<br />00212<br />00213<br />00214<br />00215<br />00216<br />00217<br />00218<br />00219<br />00220<br />
00221<br />00222<br />00223<br />00224<br />00225<br />00226<br />00227<br />00228<br />00229<br />00230<br />00231<br />00232<br />00233<br />00234<br />00235<br />00236<br />00237<br />00238<br />00239<br />00240<br />
00241<br />00242<br />00243<br />00244<br />00245<br />00246<br />00247<br />00248<br />00249<br />00250<br />00251<br />00252<br />00253<br />00254<br />00255<br />00256<br />00257<br />00258<br />00259<br />00260<br />
00261<br />00262<br />00263<br />00264<br />00265<br />00266<br />00267<br />00268<br />00269<br />00270<br />00271<br />00272<br />00273<br />00274<br />00275<br />00276<br />00277<br />00278<br />00279<br />00280<br />
00281<br />00282<br />00283<br />00284<br />00285<br />00286<br />00287<br />00288<br />00289<br />00290<br />00291<br />00292<br />00293<br />00294<br />00295<br />00296<br />00297<br />00298<br />00299<br />00300<br />
00301<br />00302<br />00303<br />00304<br />00305<br />00306<br />00307<br />00308<br />00309<br />00310<br />00311<br />00312<br />00313<br />00314<br />00315<br />00316<br />00317<br />00318<br />00319<br />00320<br />
00321<br />00322<br />00323<br />00324<br />00325<br />00326<br />00327<br />00328<br />00329<br />00330<br />00331<br />00332<br />00333<br />00334<br />00335<br />00336<br />00337<br />00338<br />00339<br />00340<br />
00341<br />00342<br />00343<br />00344<br />00345<br />00346<br />00347<br />00348<br />00349<br />00350<br />00351<br />00352<br />00353<br />00354<br />00355<br />00356<br />00357<br />00358<br />00359<br />00360<br />
00361<br />00362<br />00363<br />00364<br />00365<br />00366<br />00367<br />00368<br />00369<br />00370<br />00371<br />00372<br />00373<br />00374<br />00375<br />00376<br />00377<br />00378<br />00379<br />00380<br />
00381<br />00382<br />00383<br />00384<br />00385<br />00386<br />00387<br />00388<br />00389<br />00390<br />00391<br />00392<br />00393<br />00394<br />00395<br />00396<br />00397<br />00398<br />00399<br />00400<br />
00401<br />00402<br />00403<br />00404<br />00405<br />00406<br />00407<br />00408<br />00409<br />00410<br />00411<br />00412<br />00413<br />00414<br />00415<br />00416<br />00417<br />00418<br />00419<br />00420<br />
00421<br />00422<br />00423<br />00424<br />00425<br />00426<br />00427<br />00428<br />00429<br />00430<br />00431<br />00432<br />00433<br />00434<br />00435<br />00436<br />00437<br />00438<br />00439<br />00440<br />
00441<br />00442<br />00443<br />00444<br />00445<br />00446<br />00447<br />00448<br />00449<br />00450<br />00451<br />00452<br />00453<br />00454<br />00455<br />00456<br />00457<br />00458<br />00459<br />00460<br />
00461<br />00462<br />00463<br />00464<br />00465<br />00466<br />00467<br />00468<br />00469<br />00470<br />00471<br />00472<br />00473<br />00474<br />00475<br />00476<br />00477<br />00478<br />00479<br />00480<br />
00481<br />00482<br />00483<br />00484<br />00485<br />00486<br />00487<br />00488<br />00489<br />00490<br />00491<br />00492<br />00493<br />00494<br />00495<br />00496<br />00497<br />00498<br />00499<br />00500<br />
00501<br />00502<br />00503<br />00504<br />00505<br />00506<br />00507<br />00508<br />00509<br />00510<br />00511<br />00512<br />00513<br />00514<br />00515<br />00516<br />00517<br />00518<br />00519<br />00520<br />
00521<br />00522<br />00523<br />00524<br />00525<br />00526<br />00527<br />00528<br />00529<br />00530<br />00531<br />00532<br />00533<br />00534<br />00535<br />00536<br />00537<br />00538<br />00539<br />00540<br />
00541<br />00542<br />00543<br />00544<br />00545<br />00546<br />00547<br />00548<br />00549<br />00550<br />00551<br />00552<br />00553<br />00554<br />00555<br />00556<br />00557<br />00558<br />00559<br />00560<br />
00561<br />00562<br />00563<br />00564<br />00565<br />00566<br />00567<br />00568<br />00569<br />00570</span></td>
<td class="source"><pre class="source"><a name="0"></a><span class="source_comment">/*
<a name="2"></a>    IpToCountry 1.6 Copyright (C) 2006-2010
<a name="3"></a>
<a name="4"></a>    Initial to v1.2 by [es]Rush
<a name="5"></a>    v1.6 by Matthew 'MSuLL' Sullivan
<a name="6"></a>
<a name="7"></a>    This program is free software; you can redistribute and/or modify
<a name="8"></a>    it under the terms of the Open Unreal Mod License version 1.1.
<a name="9"></a>*/</span>
<a name="10"></a>
<a name="11"></a><span class="source_comment">/**
<a name="12"></a> * This Class does all the "Grunt Work" including querying, switching the &lt;br/&gt;
<a name="13"></a> * queryservers and receiving the IPData.
<a name="14"></a> *
<a name="15"></a> * @author Too Many!
<a name="16"></a> * @version 1A
<a name="17"></a> * @since 1A
<a name="18"></a> */</span>
<a name="19"></a>
<a name="20"></a><span class="source_keyword">class</span> <span class="source_type"><a href="../smartctf1a/httpclient.html" class="source">HTTPClient</a></span> <span class="source_keyword">extends</span> <span class="source_type"><a href="../smartctf1a/browserhttpclient.html" class="source">BrowserHTTPClient</a></span>;
<a name="21"></a>
<a name="22"></a><span class="source_comment">/*
<a name="23"></a> * Global Variables
<a name="24"></a> */</span>
<a name="25"></a>
<a name="26"></a> <span class="source_comment">/** The IpToNation Actor reference.*/</span>
<a name="27"></a> <span class="source_keyword">var</span> <span class="source_type"><a href="../smartctf1a/linkactor.html" class="source">LinkActor</a></span> <span class="source_type">S</span>;
<a name="28"></a>
<a name="29"></a> <span class="source_comment">/** Query in progress logical switch.*/</span>
<a name="30"></a> <span class="source_keyword">var</span> <span class="source_keyword">bool</span> bQueryInProgress;
<a name="31"></a>
<a name="32"></a> <span class="source_comment">/** Queue Array of IP addresses of the Players. */</span>
<a name="33"></a> <span class="source_keyword">var</span> <span class="source_keyword">string</span> QueryQueue[<span class="source_int">64</span>];
<a name="34"></a>
<a name="35"></a> <span class="source_comment">/** Queue string of the IP addresses.*/</span>
<a name="36"></a> <span class="source_keyword">var</span> <span class="source_keyword">string</span> QueryString;
<a name="37"></a>
<a name="38"></a> <span class="source_comment">/***/</span>
<a name="39"></a> <span class="source_keyword">var</span> <span class="source_keyword">bool</span> bContinueAtClose;
<a name="40"></a>
<a name="41"></a> <span class="source_comment">/** */</span>
<a name="42"></a> <span class="source_keyword">var</span> <span class="source_keyword">bool</span> bSwitchAtClose;
<a name="43"></a>
<a name="44"></a> <span class="source_comment">/***/</span>
<a name="45"></a> <span class="source_keyword">var</span> <span class="source_keyword">bool</span> bResolutionRequest;
<a name="46"></a>
<a name="47"></a> <span class="source_comment">/***/</span>
<a name="48"></a> <span class="source_keyword">var</span> <span class="source_keyword">bool</span> bReceivedData;
<a name="49"></a>
<a name="50"></a> <span class="source_comment">/***/</span>
<a name="51"></a> <span class="source_keyword">var</span> <span class="source_keyword">string</span> GMT;
<a name="52"></a>
<a name="53"></a> <span class="source_comment">/***/</span>
<a name="54"></a> <span class="source_keyword">var</span> <span class="source_keyword">int</span> Errors;
<a name="55"></a>
<a name="56"></a><span class="source_keyword">function</span> CheckAddresses()
<a name="57"></a>{
<a name="58"></a>	<span class="source_keyword">if</span>(!bResolutionRequest && <span class="source_type">S</span>.resolvedAddress[<span class="source_type">S</span>.currentServer] == <span class="source_string">""</span>)
<a name="59"></a>	{
<a name="60"></a>		bResolutionRequest = <span class="source_keyword">True</span>;
<a name="61"></a>		bQueryInProgress = <span class="source_keyword">True</span>;
<a name="62"></a>
<a name="63"></a>		Resolve(<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]);
<a name="64"></a>	}
<a name="65"></a>}
<a name="66"></a>
<a name="67"></a><span class="source_keyword">event</span> Resolved( <span class="source_type"><a href="../ipdrv/internetlink.html#IpAddr" class="source">IpAddr</a></span> <span class="source_type">Addr</span> )
<a name="68"></a>{
<a name="69"></a>	<span class="source_keyword">if</span>(bResolutionRequest)
<a name="70"></a>	{
<a name="71"></a>		<span class="source_type">S</span>.resolvedAddress[<span class="source_type">S</span>.currentServer] = IpAddrToString(<span class="source_type">Addr</span>);
<a name="72"></a>
<a name="73"></a>		<span class="source_comment">// strip out port number
</span><a name="74"></a>		<span class="source_keyword">if</span> (InStr(<span class="source_type">S</span>.resolvedAddress[<span class="source_type">S</span>.currentServer],<span class="source_string">":"</span>) != -<span class="source_int">1</span>)
<a name="75"></a>			<span class="source_type">S</span>.resolvedAddress[<span class="source_type">S</span>.currentServer] = Left(<span class="source_type">S</span>.resolvedAddress[<span class="source_type">S</span>.currentServer],InStr(<span class="source_type">S</span>.resolvedAddress[<span class="source_type">S</span>.currentServer],<span class="source_string">":"</span>));
<a name="76"></a>
<a name="77"></a>		<span class="source_type">S</span>.SaveConfig();
<a name="78"></a>
<a name="79"></a>		bResolutionRequest = <span class="source_keyword">False</span>;
<a name="80"></a>		bQueryInProgress = <span class="source_keyword">False</span>;
<a name="81"></a>
<a name="82"></a>		SendQueue();
<a name="83"></a>	}
<a name="84"></a>	<span class="source_keyword">else</span>
<a name="85"></a>	{
<a name="86"></a>		<span class="source_keyword">Super</span>.Resolved(<span class="source_type">Addr</span>);
<a name="87"></a>	}
<a name="88"></a>}
<a name="89"></a>
<a name="90"></a><span class="source_keyword">event</span> ResolveFailed()
<a name="91"></a>{
<a name="92"></a>	<span class="source_keyword">if</span>(bResolutionRequest)
<a name="93"></a>	{
<a name="94"></a>		Log(<span class="source_string">"[IpToNation] Error while resolving"</span>@<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]@<span class="source_string">"to an IP."</span>);
<a name="95"></a>		Log(<span class="source_string">"[IpToNation] If the error continues this could indicate that the operating system is not configured to resolve DNS records."</span>);
<a name="96"></a>		Log(<span class="source_string">"[IpToNation] A work-around can be performed by manually setting the value of 'resolvedAddress' to the IP To Country database host's IP in the configuration, and setting 'bNeverPurgeAddress' to True"</span>);
<a name="97"></a>
<a name="98"></a>		<span class="source_type">S</span>.restartHTTPClient(<span class="source_keyword">true</span>); <span class="source_comment">// true = also try different query server
</span><a name="99"></a>	}
<a name="100"></a>	<span class="source_keyword">else</span>
<a name="101"></a>	{
<a name="102"></a>   		SetTimer(<span class="source_int">0.0</span>, <span class="source_keyword">false</span>);
<a name="103"></a>   		SetError(-<span class="source_int">4</span>);
<a name="104"></a>	}
<a name="105"></a>}
<a name="106"></a>
<a name="107"></a><span class="source_keyword">function</span> <span class="source_keyword">string</span> SendData(<span class="source_keyword">string</span> <span class="source_type">IP</span>)
<a name="108"></a>{
<a name="109"></a>	<span class="source_keyword">local</span> <span class="source_type"><a href="../smartctf1a/linkactor.html" class="source">LinkActor</a></span> control;
<a name="110"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> <span class="source_type">i</span>;
<a name="111"></a>
<a name="112"></a>	<span class="source_keyword">if</span>(<span class="source_type">S</span> == <span class="source_keyword">None</span>)
<a name="113"></a>	{
<a name="114"></a>		<span class="source_keyword">foreach</span> AllActors(<span class="source_keyword">class</span><span class="source_name">'LinkActor'</span>, control)
<a name="115"></a>		{
<a name="116"></a>			<span class="source_type">S</span> = control;
<a name="117"></a>			<span class="source_keyword">break</span>;
<a name="118"></a>		}
<a name="119"></a>	}
<a name="120"></a>
<a name="121"></a>	<span class="source_comment">/* a way of TimeReplication to communicate with this actor */</span>
<a name="122"></a>	<span class="source_keyword">if</span>(Left(<span class="source_type">IP</span>, <span class="source_int">7</span>) == <span class="source_string">"AOLSUX "</span>)
<a name="123"></a>		AOLHandler(Mid(<span class="source_type">IP</span>, <span class="source_int">7</span>));
<a name="124"></a>
<a name="125"></a>	<span class="source_type">IP</span> = FixIpAddr(<span class="source_type">IP</span>);
<a name="126"></a>
<a name="127"></a>	<span class="source_keyword">if</span>(<span class="source_type">IP</span> == <span class="source_string">""</span>)
<a name="128"></a>	{
<a name="129"></a>		<span class="source_keyword">return</span> <span class="source_string">"!Bad Input"</span>;
<a name="130"></a>	}
<a name="131"></a>
<a name="132"></a>	<span class="source_type">i</span> = IpInDatabase(<span class="source_type">IP</span>);
<a name="133"></a>
<a name="134"></a>	<span class="source_keyword">if</span>(<span class="source_type">i</span> != -<span class="source_int">1</span>)
<a name="135"></a>	{
<a name="136"></a>		<span class="source_keyword">if</span>(InStr(<span class="source_type">S</span>.IPData[<span class="source_type">i</span>], <span class="source_string">"AMERICA ONLINE"</span>) == -<span class="source_int">1</span>)
<a name="137"></a>			<span class="source_keyword">return</span> <span class="source_type">S</span>.IPData[<span class="source_type">i</span>];
<a name="138"></a>		<span class="source_keyword">else</span>
<a name="139"></a>			<span class="source_keyword">return</span> <span class="source_string">"!AOL - Trying to clarify"</span>;
<a name="140"></a>	}
<a name="141"></a>	<span class="source_keyword">else</span> <span class="source_keyword">if</span>(IpInQueue(<span class="source_type">IP</span>))
<a name="142"></a>		<span class="source_keyword">return</span> <span class="source_string">"!Waiting in queue"</span>;
<a name="143"></a>	<span class="source_keyword">else</span> <span class="source_keyword">if</span>(InStr(QueryString, <span class="source_type">IP</span>) != -<span class="source_int">1</span>)
<a name="144"></a>		<span class="source_keyword">return</span> <span class="source_string">"!Resolving now"</span>;
<a name="145"></a>	<span class="source_keyword">else</span>
<a name="146"></a>	{
<a name="147"></a>		<span class="source_keyword">if</span>(QueryQueue[(ArrayCount(QueryQueue) - <span class="source_int">1</span>)] != <span class="source_string">""</span>)
<a name="148"></a>			<span class="source_keyword">return</span> <span class="source_string">"!Queue full"</span>;
<a name="149"></a>		<span class="source_keyword">else</span>
<a name="150"></a>		{
<a name="151"></a>			AddToQueue(<span class="source_type">IP</span>);
<a name="152"></a>			SendQueue();
<a name="153"></a>			<span class="source_keyword">return</span> <span class="source_string">"!Added to queue"</span>;
<a name="154"></a>		}
<a name="155"></a>	}
<a name="156"></a>}
<a name="157"></a>
<a name="158"></a><span class="source_keyword">function</span> HTTPReceivedData(<span class="source_keyword">string</span> <span class="source_type">data</span>)
<a name="159"></a>{
<a name="160"></a>	<span class="source_keyword">local</span> <span class="source_keyword">string</span> <span class="source_type">result</span>, temp;
<a name="161"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> elems, <span class="source_type">i</span>;
<a name="162"></a>	<span class="source_keyword">local</span> <span class="source_keyword">string</span> <span class="source_type">IP</span>;
<a name="163"></a>
<a name="164"></a>	<span class="source_type">result</span> = ParseString(<span class="source_type">data</span>);
<a name="165"></a>	elems = <span class="source_type">S</span>.ElementsNum(<span class="source_type">result</span>, <span class="source_string">","</span>);
<a name="166"></a>
<a name="167"></a>	<span class="source_keyword">Super</span>.SetTimer(<span class="source_int">0.0</span>, <span class="source_keyword">false</span>); <span class="source_comment">// disable the timeout count
</span><a name="168"></a>	bReceivedData = <span class="source_keyword">true</span>;
<a name="169"></a>
<a name="170"></a>	GMT=left(<span class="source_type">result</span>, <span class="source_int">5</span>); <span class="source_comment">// get the GMT time of a query server
</span><a name="171"></a>	<span class="source_type">result</span>=Mid(<span class="source_type">result</span>, <span class="source_int">6</span>); <span class="source_comment">// leave the rest of the string in the good old format
</span><a name="172"></a>
<a name="173"></a>	<span class="source_keyword">if</span>(InStr(<span class="source_type">result</span>, <span class="source_string">"Warning"</span>) != -<span class="source_int">1</span>) <span class="source_comment">// php warning ?
</span><a name="174"></a>	{
<a name="175"></a>		SwitchQueryServer(<span class="source_string">"IpToNation: "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]$<span class="source_string">" returned bad data! Switching to alternate."</span>);
<a name="176"></a>		SendQueue();
<a name="177"></a>		<span class="source_keyword">return</span>;
<a name="178"></a>	}
<a name="179"></a>	<span class="source_keyword">if</span>(elems==<span class="source_int">1</span>)
<a name="180"></a>	{
<a name="181"></a>		<span class="source_type">IP</span>=<span class="source_type">S</span>.SelElem(<span class="source_type">result</span>, <span class="source_int">1</span>);
<a name="182"></a>		<span class="source_keyword">if</span>(<span class="source_type">S</span>.ElementsNum(<span class="source_type">result</span>)!=<span class="source_int">5</span>  || FixIpAddr(<span class="source_type">IP</span>) == <span class="source_string">""</span>) <span class="source_comment">// some weird data ?
</span><a name="183"></a>		{
<a name="184"></a>			SwitchQueryServer(<span class="source_string">"IpToCountry: "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]$<span class="source_string">" returned bad data! Switching to alternate."</span>);
<a name="185"></a>			SendQueue();
<a name="186"></a>			<span class="source_keyword">return</span>;
<a name="187"></a>		}
<a name="188"></a>		<span class="source_keyword">if</span>(Right(<span class="source_type">S</span>.SelElem(<span class="source_type">result</span>, <span class="source_int">2</span>), <span class="source_int">8</span>) == <span class="source_string">".aol.com"</span> && <span class="source_type">S</span>.bCheckAOL)
<a name="189"></a>		{
<a name="190"></a>			SaveIPData(SetAOL(<span class="source_type">result</span>)); <span class="source_comment">/* save IP to keep the record, this data won't be returned anywhere anyway */</span>
<a name="191"></a>			InitAOLCheck(<span class="source_type">IP</span>);
<a name="192"></a>		}
<a name="193"></a>		<span class="source_keyword">else</span>
<a name="194"></a>   		SaveIPData(<span class="source_type">result</span>);
<a name="195"></a>  	}
<a name="196"></a> 	<span class="source_keyword">else</span>
<a name="197"></a> 	{
<a name="198"></a> 	 	<span class="source_keyword">for</span>(<span class="source_type">i</span>=<span class="source_int">1</span>;<span class="source_type">i</span>&lt;=elems;<span class="source_type">i</span>++)
<a name="199"></a> 	 	{
<a name="200"></a> 	 		temp=<span class="source_type">S</span>.SelElem(<span class="source_type">result</span>, <span class="source_type">i</span>, <span class="source_string">","</span>);
<a name="201"></a> 	 		<span class="source_type">IP</span>=<span class="source_type">S</span>.SelElem(temp, <span class="source_int">1</span>);
<a name="202"></a>			<span class="source_keyword">if</span>(<span class="source_type">i</span>==<span class="source_int">1</span>)
<a name="203"></a>			{
<a name="204"></a>				<span class="source_keyword">if</span>(<span class="source_type">S</span>.ElementsNum(temp)!=<span class="source_int">5</span> || FixIpAddr(<span class="source_type">IP</span>) == <span class="source_string">""</span>) <span class="source_comment">// some weird data ?
</span><a name="205"></a>				{
<a name="206"></a>					SwitchQueryServer(<span class="source_string">"IpToCountry: "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]$<span class="source_string">" returned bad data! Switching to alternate."</span>);
<a name="207"></a>					SendQueue();
<a name="208"></a>					<span class="source_keyword">return</span>;
<a name="209"></a>				}
<a name="210"></a>			}
<a name="211"></a>			<span class="source_keyword">if</span>(Right(<span class="source_type">S</span>.SelElem(temp, <span class="source_int">2</span>), <span class="source_int">8</span>) == <span class="source_string">".aol.com"</span> && <span class="source_type">S</span>.bCheckAOL)
<a name="212"></a>			{
<a name="213"></a>				SaveIPData(SetAOL(temp));
<a name="214"></a>				InitAOLCheck(<span class="source_type">IP</span>);
<a name="215"></a>			}
<a name="216"></a>			<span class="source_keyword">else</span>
<a name="217"></a>				SaveIPData(temp);
<a name="218"></a> 	 	}
<a name="219"></a> 	}
<a name="220"></a>
<a name="221"></a> 	QueryString=<span class="source_string">""</span>;
<a name="222"></a>	bQueryInProgress=<span class="source_keyword">False</span>;
<a name="223"></a>
<a name="224"></a>	SendQueue();
<a name="225"></a>}
<a name="226"></a>
<a name="227"></a><span class="source_keyword">function</span> <span class="source_keyword">string</span> SetAOL(<span class="source_keyword">string</span> Input)
<a name="228"></a>{
<a name="229"></a>	<span class="source_keyword">return</span> <span class="source_type">S</span>.SelElem(Input, <span class="source_int">1</span>)$<span class="source_string">":"</span>$<span class="source_type">S</span>.SelElem(Input, <span class="source_int">2</span>)$<span class="source_string">":AMERICA ONLINE:AOL:us"</span>;
<a name="230"></a>}
<a name="231"></a>
<a name="232"></a><span class="source_keyword">function</span> <span class="source_keyword">bool</span> InitAOLCheck(<span class="source_keyword">string</span> <span class="source_type">IP</span>)
<a name="233"></a>{
<a name="234"></a>	<span class="source_keyword">local</span> <span class="source_type"><a href="../engine/controller.html" class="source">Controller</a></span> <span class="source_type">P</span>;
<a name="235"></a>	<span class="source_keyword">local</span> <span class="source_type"><a href="../smartctf1a/timereplication.html" class="source">TimeReplication</a></span> TR;
<a name="236"></a>
<a name="237"></a>	<span class="source_keyword">for</span>(<span class="source_type">P</span> = <span class="source_type">Level</span>.ControllerList; <span class="source_type">P</span> != <span class="source_keyword">None</span>; <span class="source_type">P</span> = <span class="source_type">P</span>.nextController )
<a name="238"></a>		<span class="source_keyword">if</span>(<span class="source_type">P</span>.IsA(<span class="source_name">'PlayerController'</span>))
<a name="239"></a>			<span class="source_keyword">if</span>(NetConnection(<span class="source_type"><a href="../engine/playercontroller.html" class="source">PlayerController</a></span>(<span class="source_type">P</span>).<span class="source_type"><a href="../engine/player.html" class="source">Player</a></span>) != <span class="source_keyword">None</span>)
<a name="240"></a>			{
<a name="241"></a>				<span class="source_keyword">if</span>(<span class="source_type">S</span>.SepLeft(<span class="source_type"><a href="../engine/playercontroller.html" class="source">PlayerController</a></span>(<span class="source_type">P</span>).GetPlayerNetworkAddress()) == <span class="source_type">IP</span>)
<a name="242"></a>				{
<a name="243"></a>					TR = Spawn(<span class="source_keyword">class</span><span class="source_name">'TimeReplication'</span>, <span class="source_type">P</span>);
<a name="244"></a>					TR.IpToNation = self.<span class="source_type">S</span>;
<a name="245"></a>					<span class="source_keyword">return</span> <span class="source_keyword">true</span>;
<a name="246"></a>				}
<a name="247"></a>			}
<a name="248"></a>	<span class="source_keyword">return</span> <span class="source_keyword">false</span>;
<a name="249"></a>}
<a name="250"></a>
<a name="251"></a><span class="source_keyword">event</span> Opened()
<a name="252"></a>{
<a name="253"></a>	Enable(<span class="source_name">'Tick'</span>);
<a name="254"></a>
<a name="255"></a>	<span class="source_keyword">if</span>(ProxyServerAddress != <span class="source_string">""</span>)
<a name="256"></a>	{
<a name="257"></a>		SendBufferedData(<span class="source_string">"GET http://"</span>$<span class="source_type">ServerAddress</span>$<span class="source_string">":"</span>$<span class="source_keyword">string</span>(ServerPort)$ServerURI$<span class="source_string">" HTTP/1.1"</span>$CR$LF);
<a name="258"></a>	}
<a name="259"></a>	<span class="source_keyword">else</span>
<a name="260"></a>	{
<a name="261"></a>		SendBufferedData(<span class="source_string">"GET "</span>$ServerURI$<span class="source_string">" HTTP/1.1"</span>$CR$LF);
<a name="262"></a>	}
<a name="263"></a>
<a name="264"></a>	SendBufferedData(<span class="source_string">"Connection: close"</span>$CR$LF);
<a name="265"></a>	SendBufferedData(<span class="source_string">"Host: "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]$<span class="source_string">":"</span>$<span class="source_type">S</span>.QueryServerPort[<span class="source_type">S</span>.currentServer]$CR$LF);
<a name="266"></a>	SendBufferedData(<span class="source_string">"User-Agent: Mozilla/5.0 (Unreal Tournament)"</span>$CR$LF$CR$LF);
<a name="267"></a>
<a name="268"></a>	CurrentState = WaitingForHeader;
<a name="269"></a>}
<a name="270"></a>
<a name="271"></a><span class="source_keyword">function</span> AOLHandler(<span class="source_keyword">string</span> <span class="source_type">Data</span>)
<a name="272"></a>{
<a name="273"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> ClientTime;
<a name="274"></a>	<span class="source_keyword">local</span> <span class="source_keyword">string</span> <span class="source_type">IP</span>;
<a name="275"></a>
<a name="276"></a>	<span class="source_type">IP</span>=<span class="source_type">S</span>.SelElem(<span class="source_type">Data</span>, <span class="source_int">1</span>);
<a name="277"></a>	ClientTime = <span class="source_keyword">int</span>(<span class="source_type">S</span>.SelElem(<span class="source_type">Data</span>, <span class="source_int">2</span>))*<span class="source_int">60</span> + <span class="source_keyword">int</span>(<span class="source_type">S</span>.SelElem(<span class="source_type">Data</span>, <span class="source_int">3</span>));
<a name="278"></a>
<a name="279"></a>	UpdateAOLData(<span class="source_type">IP</span>$<span class="source_string">":"</span>$GetAOLArrayCountry(ClientTime));
<a name="280"></a>}
<a name="281"></a>
<a name="282"></a><span class="source_keyword">function</span> <span class="source_keyword">string</span> GetAOLArrayCountry(<span class="source_keyword">int</span> ClientTime)
<a name="283"></a>{
<a name="284"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> GMTTime;
<a name="285"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> TimeDiff;
<a name="286"></a>	<span class="source_keyword">local</span> <span class="source_keyword">string</span> ArrayCountry;
<a name="287"></a>
<a name="288"></a>	GMTTime = <span class="source_keyword">int</span>(<span class="source_type">S</span>.SelElem(GMT, <span class="source_int">1</span>))*<span class="source_int">60</span> + <span class="source_keyword">int</span>(<span class="source_type">S</span>.SelElem(GMT, <span class="source_int">1</span>));
<a name="289"></a>	TimeDiff = abs(GMTTime - ClientTime) % <span class="source_int">1440</span>;
<a name="290"></a>
<a name="291"></a>	<span class="source_keyword">if</span> (TimeDiff &gt; <span class="source_int">720</span>)
<a name="292"></a>		TimeDiff = abs(TimeDiff - <span class="source_int">1440</span>);
<a name="293"></a>
<a name="294"></a>	<span class="source_keyword">if</span> (TimeDiff &lt; <span class="source_int">30</span>)
<a name="295"></a>		ArrayCountry = <span class="source_string">"UNITED KINGDOM:GBR:gb"</span>;
<a name="296"></a>	<span class="source_keyword">else</span> <span class="source_keyword">if</span> (TimeDiff &lt; <span class="source_int">120</span>)
<a name="297"></a>		ArrayCountry = <span class="source_string">"GERMANY:DEU:de"</span>;
<a name="298"></a>	<span class="source_keyword">else</span>
<a name="299"></a>		ArrayCountry = <span class="source_string">"UNITED STATES:USA:us"</span>;
<a name="300"></a>
<a name="301"></a>	<span class="source_keyword">return</span> ArrayCountry;
<a name="302"></a>}
<a name="303"></a>
<a name="304"></a><span class="source_keyword">function</span> SwitchQueryServer(<span class="source_keyword2">optional</span> <span class="source_keyword">string</span> LogStr)
<a name="305"></a>{
<a name="306"></a>	<span class="source_keyword">if</span>(LogStr != <span class="source_string">""</span>)
<a name="307"></a>		log(LogStr);
<a name="308"></a>
<a name="309"></a>	bQueryInProgress = <span class="source_keyword">False</span>;
<a name="310"></a>
<a name="311"></a>	<span class="source_keyword">if</span>(++Errors &gt; <span class="source_type">S</span>.ErrorLimit)
<a name="312"></a>	{
<a name="313"></a>		<span class="source_keyword">if</span>(!bReceivedData && !<span class="source_type">S</span>.bNeverPurgeAddress)
<a name="314"></a>		{
<a name="315"></a>			Log(<span class="source_string">"[IpToNation] No data was received during the last session; will attempt to re-resolve"</span>@<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]@<span class="source_string">"upon HTTP client reload."</span>);
<a name="316"></a>			<span class="source_type">S</span>.resolvedAddress[<span class="source_type">S</span>.currentServer] = <span class="source_string">""</span>;
<a name="317"></a>			<span class="source_type">S</span>.SaveConfig();
<a name="318"></a>		}
<a name="319"></a>		<span class="source_type">S</span>.restartHTTPClient();
<a name="320"></a>	}
<a name="321"></a>	<span class="source_keyword">else</span>
<a name="322"></a>	{
<a name="323"></a>		<span class="source_keyword">if</span>((<span class="source_type">S</span>.currentServer + <span class="source_int">1</span>) == <span class="source_type">S</span>.NumberOfServers)
<a name="324"></a>		{
<a name="325"></a>			<span class="source_type">S</span>.currentServer = <span class="source_int">0</span>;
<a name="326"></a>		}
<a name="327"></a>		<span class="source_keyword">else</span>
<a name="328"></a>		{
<a name="329"></a>			<span class="source_type">S</span>.currentServer++;
<a name="330"></a>		}
<a name="331"></a>
<a name="332"></a>		ServerIpAddr.<span class="source_type">Addr</span>=<span class="source_int">0</span>; <span class="source_comment">// ensures that the Browse() function will open a connection to a new address
</span><a name="333"></a>	}
<a name="334"></a>}
<a name="335"></a>
<a name="336"></a><span class="source_comment">// override original function to silence the warning log
</span><a name="337"></a><span class="source_keyword">function</span> DoBind()
<a name="338"></a>{
<a name="339"></a>	<span class="source_keyword">if</span>( BindPort() == <span class="source_int">0</span> )
<a name="340"></a>	{
<a name="341"></a>		SetError(-<span class="source_int">2</span>);
<a name="342"></a>		<span class="source_keyword">return</span>;
<a name="343"></a>	}
<a name="344"></a>
<a name="345"></a>	Open( ServerIpAddr );
<a name="346"></a>	bClosed = <span class="source_keyword">False</span>;
<a name="347"></a>}
<a name="348"></a>
<a name="349"></a><span class="source_keyword">function</span> SetError(<span class="source_keyword">int</span> <span class="source_type">code</span>)
<a name="350"></a>{
<a name="351"></a>	<span class="source_keyword">Super</span>.SetError(<span class="source_type">code</span>);
<a name="352"></a>
<a name="353"></a>	<span class="source_keyword">switch</span>(<span class="source_type">code</span>)
<a name="354"></a>	{
<a name="355"></a>		<span class="source_keyword">case</span> -<span class="source_int">1</span>:
<a name="356"></a>			Log(<span class="source_string">"[IpToNation] Error in binding the port while connecting to "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]);
<a name="357"></a>			<span class="source_keyword">break</span>;
<a name="358"></a>		<span class="source_keyword">case</span> -<span class="source_int">2</span>:
<a name="359"></a>         		Log(<span class="source_string">"[IpToNation] Error while resolving the host "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]);
<a name="360"></a>         		<span class="source_keyword">break</span>;
<a name="361"></a>		<span class="source_keyword">case</span> -<span class="source_int">3</span>:
<a name="362"></a>			Log(<span class="source_string">"[IpToNation] "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]$<span class="source_string">" timed out after "</span>$<span class="source_keyword">string</span>(<span class="source_type">S</span>.MaxTimeout)$<span class="source_string">" seconds"</span>);
<a name="363"></a>			<span class="source_keyword">break</span>;
<a name="364"></a>		<span class="source_keyword">case</span> -<span class="source_int">4</span>:
<a name="365"></a>			Log(<span class="source_string">"[IpToNation] Error resolving to the host of the IP for the domain "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]);
<a name="366"></a>			<span class="source_keyword">break</span>;
<a name="367"></a>		default:
<a name="368"></a>			Log(<span class="source_string">"[IpToNation] Server received HTTP error with code "</span>$<span class="source_keyword">string</span>(<span class="source_type">code</span>)$<span class="source_string">" from "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]);
<a name="369"></a>	}
<a name="370"></a>
<a name="371"></a>	<span class="source_comment">// sometimes the connection doesn't break immediately, it is probably due to some bug in BrowserHTTPClient, if it happens we have to wait for it inside event Closed() cause we cannot open the same socket if it is already opened
</span><a name="372"></a>	<span class="source_keyword">if</span>(IsConnected())
<a name="373"></a>	{
<a name="374"></a>		bSwitchAtClose=<span class="source_keyword">True</span>;
<a name="375"></a>	}
<a name="376"></a>	<span class="source_keyword">else</span>
<a name="377"></a>	{
<a name="378"></a>		SwitchQueryServer(<span class="source_string">"[IpToNation] "</span>$<span class="source_type">S</span>.QueryServerHost[<span class="source_type">S</span>.currentServer]$<span class="source_string">" failed! Trying the alternate server..."</span>);
<a name="379"></a>		SendQueue();
<a name="380"></a>	}
<a name="381"></a>}
<a name="382"></a>
<a name="383"></a><span class="source_keyword">event</span> Closed()
<a name="384"></a>{
<a name="385"></a>	<span class="source_keyword">Super</span>.Closed();
<a name="386"></a>	bQueryInProgress=<span class="source_keyword">False</span>;
<a name="387"></a>
<a name="388"></a>	<span class="source_keyword">if</span>(bSwitchAtClose)
<a name="389"></a>	{
<a name="390"></a>		<span class="source_comment">//NoSendQueue = True;
</span><a name="391"></a>		<span class="source_comment">//HTTPReceivedData(InputBuffer);
</span><a name="392"></a>
<a name="393"></a>		bSwitchAtClose=<span class="source_keyword">False</span>;
<a name="394"></a>		SwitchQueryServer();
<a name="395"></a>		SendQueue();
<a name="396"></a>	}
<a name="397"></a>	<span class="source_keyword">else</span> <span class="source_keyword">if</span>(bContinueAtClose)
<a name="398"></a>	{
<a name="399"></a>		<span class="source_comment">//NoSendQueue = True;
</span><a name="400"></a>		<span class="source_comment">//HTTPReceivedData(InputBuffer);
</span><a name="401"></a>
<a name="402"></a>		bContinueAtClose=<span class="source_keyword">False</span>;
<a name="403"></a>		bQueryInProgress=<span class="source_keyword">False</span>;
<a name="404"></a>		SendQueue();
<a name="405"></a>	}
<a name="406"></a>}
<a name="407"></a>
<a name="408"></a><span class="source_keyword">function</span> SendQueue()
<a name="409"></a>{
<a name="410"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> <span class="source_type">i</span>;
<a name="411"></a>	<span class="source_keyword">local</span> <span class="source_keyword">string</span> <span class="source_type">IP</span>;
<a name="412"></a>
<a name="413"></a>	CheckAddresses();
<a name="414"></a>
<a name="415"></a>	<span class="source_keyword">if</span>(IsConnected())
<a name="416"></a>	{
<a name="417"></a>		bContinueAtClose=<span class="source_keyword">True</span>;
<a name="418"></a>	}
<a name="419"></a>
<a name="420"></a>	<span class="source_keyword">if</span>(bQueryInProgress || (QueryQueue[<span class="source_int">0</span>] == <span class="source_string">""</span> && QueryString == <span class="source_string">""</span>))
<a name="421"></a>	{
<a name="422"></a>		<span class="source_keyword">return</span>;
<a name="423"></a>	}
<a name="424"></a>
<a name="425"></a>	<span class="source_keyword">for</span>(<span class="source_type">i</span>=<span class="source_int">0</span>;<span class="source_type">i</span>&lt;ArrayCount(QueryQueue);<span class="source_type">i</span>++)
<a name="426"></a>	{
<a name="427"></a>		<span class="source_keyword">if</span>(QueryQueue[<span class="source_type">i</span>] == <span class="source_string">""</span>)
<a name="428"></a>			continue;
<a name="429"></a>		<span class="source_type">IP</span>=QueryQueue[<span class="source_type">i</span>];
<a name="430"></a>		<span class="source_keyword">if</span>(QueryString==<span class="source_string">""</span>)
<a name="431"></a>			QueryString=QueryQueue[<span class="source_type">i</span>];
<a name="432"></a>		<span class="source_keyword">else</span>
<a name="433"></a>			QueryString=QueryString$<span class="source_string">","</span>$QueryQueue[<span class="source_type">i</span>];
<a name="434"></a>		QueryQueue[<span class="source_type">i</span>]=<span class="source_string">""</span>;
<a name="435"></a>	}
<a name="436"></a>
<a name="437"></a>	<span class="source_keyword">if</span>(QueryString == <span class="source_string">""</span>)
<a name="438"></a>	{
<a name="439"></a>		<span class="source_keyword">return</span>;
<a name="440"></a>	}
<a name="441"></a>
<a name="442"></a>	bQueryInProgress=<span class="source_keyword">True</span>;
<a name="443"></a>
<a name="444"></a>	Browse(<span class="source_type">S</span>.resolvedAddress[<span class="source_type">S</span>.currentServer],<span class="source_type">S</span>.QueryServerFilePath[<span class="source_type">S</span>.currentServer]$<span class="source_string">"?ip="</span>$QueryString, <span class="source_type">S</span>.QueryServerPort[<span class="source_type">S</span>.currentServer], <span class="source_type">S</span>.MaxTimeout);
<a name="445"></a>}
<a name="446"></a>
<a name="447"></a><span class="source_keyword">function</span> AddToQueue(<span class="source_keyword">string</span> <span class="source_type">data</span>)
<a name="448"></a>{
<a name="449"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> <span class="source_type">i</span>;
<a name="450"></a>
<a name="451"></a>	<span class="source_keyword">if</span>(IpInDatabase(<span class="source_type">data</span>) != -<span class="source_int">1</span> || InStr(QueryString, <span class="source_type">data</span>) != -<span class="source_int">1</span>)
<a name="452"></a>	{
<a name="453"></a>		<span class="source_keyword">return</span>;
<a name="454"></a>	}
<a name="455"></a>
<a name="456"></a>	<span class="source_keyword">for</span>(<span class="source_type">i</span>=<span class="source_int">0</span>;<span class="source_type">i</span>&lt;ArrayCount(QueryQueue);<span class="source_type">i</span>++)
<a name="457"></a>	{
<a name="458"></a>		<span class="source_keyword">if</span>(QueryQueue[<span class="source_type">i</span>]!=<span class="source_string">""</span>)
<a name="459"></a>			continue;
<a name="460"></a>		QueryQueue[<span class="source_type">i</span>] = <span class="source_type">data</span>;
<a name="461"></a>		<span class="source_keyword">if</span>(!bQueryInProgress)
<a name="462"></a>			SendQueue();
<a name="463"></a>		<span class="source_keyword">break</span>;
<a name="464"></a>	}
<a name="465"></a>}
<a name="466"></a>
<a name="467"></a><span class="source_keyword">function</span> UpdateAOLData(<span class="source_keyword">string</span> SetString)
<a name="468"></a>{
<a name="469"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> <span class="source_type">i</span>;
<a name="470"></a>	<span class="source_keyword">local</span> <span class="source_keyword">string</span> <span class="source_type">IP</span>, Rest;
<a name="471"></a>
<a name="472"></a>	<span class="source_type">IP</span> = <span class="source_type">S</span>.SelElem(SetString, <span class="source_int">1</span>);
<a name="473"></a>	Rest = Mid(SetString, InStr(SetString, <span class="source_string">":"</span>)+<span class="source_int">1</span>); <span class="source_comment">/* rest of the elements */</span>
<a name="474"></a>
<a name="475"></a>	<span class="source_keyword">for</span>(<span class="source_type">i</span>=<span class="source_int">0</span>;<span class="source_type">i</span>&lt;ArrayCount(<span class="source_type">S</span>.IPData);<span class="source_type">i</span>++)
<a name="476"></a>	{
<a name="477"></a>		<span class="source_keyword">if</span>(<span class="source_type">S</span>.SepLeft(<span class="source_type">S</span>.IPData[<span class="source_type">i</span>]) == <span class="source_type">IP</span>)
<a name="478"></a>		{
<a name="479"></a>			<span class="source_type">S</span>.IPData[<span class="source_type">i</span>] = <span class="source_type">IP</span>$<span class="source_string">":"</span>$<span class="source_type">S</span>.SelElem(<span class="source_type">S</span>.IPData[<span class="source_type">i</span>], <span class="source_int">2</span>)$<span class="source_string">":"</span>$Rest;
<a name="480"></a>			<span class="source_type">S</span>.SaveConfig();
<a name="481"></a>			<span class="source_keyword">return</span>;
<a name="482"></a>		}
<a name="483"></a>	}
<a name="484"></a>	SaveIPData(SetString); <span class="source_comment">/* just in case there's nothing to alter, add new data */</span>
<a name="485"></a>}
<a name="486"></a>
<a name="487"></a><span class="source_keyword">function</span> <span class="source_keyword">bool</span> SaveIPData(<span class="source_keyword">string</span> SetString)
<a name="488"></a>{
<a name="489"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> <span class="source_type">i</span>;
<a name="490"></a>
<a name="491"></a>	<span class="source_keyword">for</span>(<span class="source_type">i</span>=<span class="source_int">0</span>;<span class="source_type">i</span>&lt;ArrayCount(<span class="source_type">S</span>.IPData);<span class="source_type">i</span>++)
<a name="492"></a>	{
<a name="493"></a>		<span class="source_keyword">if</span>(<span class="source_type">S</span>.IPData[<span class="source_type">i</span>] != <span class="source_string">""</span>)
<a name="494"></a>			continue;
<a name="495"></a>		<span class="source_type">S</span>.IPData[<span class="source_type">i</span>]=SetString;
<a name="496"></a>		<span class="source_type">S</span>.SaveConfig();
<a name="497"></a>		<span class="source_keyword">return</span> <span class="source_keyword">true</span>;
<a name="498"></a>	}
<a name="499"></a>
<a name="500"></a>	<span class="source_type">S</span>.IPData[<span class="source_type">S</span>.IPDataIndex] = SetString;
<a name="501"></a>	<span class="source_type">S</span>.IPDataIndex = (<span class="source_type">S</span>.IPDataIndex+<span class="source_int">1</span>) % ArrayCount(<span class="source_type">S</span>.IPData);
<a name="502"></a>	<span class="source_type">S</span>.SaveConfig();
<a name="503"></a>}
<a name="504"></a>
<a name="505"></a><span class="source_keyword">function</span> <span class="source_keyword">int</span> IpInDatabase(<span class="source_keyword">string</span> <span class="source_type">IP</span>)
<a name="506"></a>{
<a name="507"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> <span class="source_type">i</span>;
<a name="508"></a>
<a name="509"></a>	<span class="source_keyword">for</span>(<span class="source_type">i</span>=<span class="source_int">0</span>;<span class="source_type">i</span>&lt;ArrayCount(<span class="source_type">S</span>.IPData);<span class="source_type">i</span>++)
<a name="510"></a>	{
<a name="511"></a>		<span class="source_keyword">if</span>(<span class="source_type">S</span>.SepLeft(<span class="source_type">S</span>.IPData[<span class="source_type">i</span>]) == <span class="source_type">IP</span>)
<a name="512"></a>			<span class="source_keyword">return</span> <span class="source_type">i</span>;
<a name="513"></a>	}
<a name="514"></a>	<span class="source_keyword">return</span> -<span class="source_int">1</span>;
<a name="515"></a>}
<a name="516"></a>
<a name="517"></a><span class="source_keyword">function</span> <span class="source_keyword">bool</span> IpInQueue(<span class="source_keyword">string</span> <span class="source_type">data</span>)
<a name="518"></a>{
<a name="519"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> <span class="source_type">i</span>;
<a name="520"></a>
<a name="521"></a>	<span class="source_keyword">for</span>(<span class="source_type">i</span>=<span class="source_int">0</span>;<span class="source_type">i</span>&lt;ArrayCount(QueryQueue);<span class="source_type">i</span>++)
<a name="522"></a>	{
<a name="523"></a>		<span class="source_keyword">if</span>(QueryQueue[<span class="source_type">i</span>] == <span class="source_type">data</span>)
<a name="524"></a>			<span class="source_keyword">return</span> <span class="source_keyword">true</span>;
<a name="525"></a>	}
<a name="526"></a>	<span class="source_keyword">return</span> <span class="source_keyword">false</span>;
<a name="527"></a>}
<a name="528"></a>
<a name="529"></a><span class="source_keyword">function</span> <span class="source_keyword">string</span> FixIpAddr(<span class="source_keyword">string</span> <span class="source_type">IP</span>)
<a name="530"></a>{
<a name="531"></a>	<span class="source_keyword">local</span> <span class="source_type"><a href="../ipdrv/internetlink.html#IpAddr" class="source">IpAddr</a></span> <span class="source_type">Addr</span>;
<a name="532"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> <span class="source_type">i</span>;
<a name="533"></a>	<span class="source_keyword">local</span> <span class="source_keyword">String</span> StrAddr;
<a name="534"></a>
<a name="535"></a>	<span class="source_keyword">if</span>(!StringToIpAddr(<span class="source_type">IP</span>, <span class="source_type">Addr</span>))
<a name="536"></a>		<span class="source_keyword">return</span> <span class="source_string">""</span>;
<a name="537"></a>	StrAddr=IpAddrToString(<span class="source_type">Addr</span>);
<a name="538"></a>	<span class="source_type">i</span> = InStr(StrAddr, <span class="source_string">":"</span>);
<a name="539"></a>	<span class="source_keyword">if</span>(<span class="source_type">i</span> != -<span class="source_int">1</span>)
<a name="540"></a>		StrAddr = Left(StrAddr, <span class="source_type">i</span>);
<a name="541"></a>	<span class="source_keyword">else</span>
<a name="542"></a>		<span class="source_keyword">return</span> <span class="source_string">""</span>;
<a name="543"></a>	<span class="source_keyword">return</span> StrAddr;
<a name="544"></a>}
<a name="545"></a>
<a name="546"></a><span class="source_keyword">function</span> <span class="source_keyword">string</span> ParseString (<span class="source_keyword">String</span> Input)
<a name="547"></a>{
<a name="548"></a>	<span class="source_keyword">local</span> <span class="source_keyword">int</span> LCRLF;
<a name="549"></a>	<span class="source_keyword">local</span> <span class="source_keyword">string</span> <span class="source_type">result</span>;
<a name="550"></a>
<a name="551"></a>	LCRLF = InStr(Input ,CR$LF);
<a name="552"></a>
<a name="553"></a>	<span class="source_comment">// No CR or LF in string
</span><a name="554"></a>	<span class="source_keyword">if</span> (LCRLF == -<span class="source_int">1</span>)
<a name="555"></a>		<span class="source_keyword">return</span> Input;
<a name="556"></a>	<span class="source_keyword">else</span>
<a name="557"></a>	{
<a name="558"></a>		<span class="source_type">result</span> = Right(Input, <span class="source_type">len</span>(Input)-LCRLF-<span class="source_int">2</span>);
<a name="559"></a>		LCRLF = InStr(<span class="source_type">result</span> ,CR$LF);
<a name="560"></a>		<span class="source_type">result</span> = Left(<span class="source_type">result</span>, LCRLF);
<a name="561"></a>		<span class="source_keyword">return</span> <span class="source_type">result</span>;
<a name="562"></a>	}
<a name="563"></a>}
<a name="564"></a>
<a name="565"></a><span class="source_keyword">defaultproperties</span>
<a name="566"></a>{
<a name="567"></a>    Tag=<span class="source_name">'HTTPClient'</span>
<a name="568"></a>    bHidden=<span class="source_keyword">true</span>
<a name="569"></a>}
<a name="570"></a></pre></td></tr></table></div>
<hr />
<table class="header">
<tr class="header">
	<td class="header"><a href="../overview.html">Overview</a></td>
	<td class="header"><a href="../smartctf1a/smartctf1a-overview.html">Package</a></td>
	<td class="header"><a href="../smartctf1a/httpclient.html">Class</a></td>
	<td class="header_hilight">Source</td>
	<td class="header"><a class="header" href="../classtree.html#HTTPClient">Class tree</a></td>
	<td class="header"><a class="header" href="../glossary_A.html">Glossary</a></td>
	<td class="logo" rowspan="2">UnrealScript<br />Documentation</td>
</tr>
<tr>
	<td class="subheader" colspan="3"><a href="../Source_smartctf1a/browserhttpclient.html">previous class</a> &nbsp;&nbsp;&nbsp;&nbsp; <a href="../Source_smartctf1a/linkactor.html">next class</a></td>
	<td class="subheader" colspan="2"><a href="../index.html" target="_top">frames</a> &nbsp;&nbsp;&nbsp;&nbsp; <a href="" target="_top">no frames</a></td>
</tr>
</table>

<div class="stats">Class file time: Mon 15/4/2019 09:51:08.000 - Creation time: Mon 15/4/2019 10:25:10.691 - Created with <a href="http://wiki.beyondunreal.com/wiki/UnCodeX" target="_blank">UnCodeX</a></div>

</body>
</html>